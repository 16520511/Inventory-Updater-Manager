<!doctype html>
<html>
  <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
  </head>
  <body>
    <style>
      th, .update-btn {
        text-align: center !important;
      }
    </style>
    <%- include('navbar'); %>
    <div id="table-container" style="padding: 15px 35px;">
      <div style="margin-top: 10rem;" class="loading-spinner text-center">
        <div class="spinner-border" style="width: 3rem; height: 3rem;"  role="status">
          <span class="sr-only">Loading...</span>
        </div>
        <h4>Đang tải dữ liệu...</h4>
      </div>
    </div>
      
      <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
      <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.18/b-1.5.6/sl-1.3.0/datatables.min.css"/>
 
      <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.18/b-1.5.6/sl-1.3.0/datatables.min.js"></script>
      
      <script>
      $(document).ready(function() {
        $.ajax({
            url: '/get-products',
            method: 'POST',
            data: {}
            }).done(function(res) {
                console.log(res.products);
                var tableDOM = `<table id="products_table" class="table display">
                <thead class="thead-dark">
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">SKU</th>
                    <th scope="col">Tên</th>
                    <th scope="col">Giá</th>
                    <th scope="col">Tình trạng</th>
                    <th scope="col">Cập nhật</th>
                  </tr>
                </thead>
                <tbody>`;
                for(var i = 0; i<res.products.length; i++) {
                  var inStock = res.products[i].in_stock == true ? 'Còn hàng' : 'Hết hàng';
                  tableDOM += `<tr>
                  <th scope="row">${i+1}</th>
                  <td>${res.products[i].sku}</td>
                  <td>${res.products[i].name}</td>
                  <td contenteditable class="price-field">${res.products[i].price}</td>
                  <td contenteditable>${inStock}</td>
                  <td class="update-btn">
                      <button class="update-click btn btn-dark" data-toggle="popover" title="Thành công" data-content="Sản phẩm đã được cập nhật">Cập nhật</button>
                  </td>
                  </tr>`;
                }
                tableDOM += `</tbody>
                  </table>`;
                $(".loading-spinner").remove();
                $("#table-container").append(tableDOM);

                $(".price-field").keypress(function(e) {
                  if (e.which < 48 || e.which > 57) e.preventDefault();
                });

                $(".update-btn").each((index) => {
                  var updateBtn = $(".update-btn").eq(index);
                  var inStock = updateBtn.prev();
                  var price = inStock.prev();
                  var sku = price.prev().prev();

                  console.log(sku.text());
                  // if(inStock.text().trim() != "Còn hàng")
                  var updateClickBtn = $(".update-click").eq(index);
                  updateClickBtn.click(() => {
                    $.ajax({
                    url: '/update-single-product',
                    method: 'POST',
                    data: { sku: sku.text(), price: price.text(), inStock: inStock.text().trim() }
                    }).done(function(res) {
                        if (res.success) {
                        updateClickBtn.popover('show');
                        setTimeout(function() {
                          updateClickBtn.popover("hide")}, 2200); 
                        console.log('id from ajax call is', res);
                    } else {
                        updateClickBtn.attr({"data-content": "Lỗi cập nhật sản phẩm", "title": "Thất bại"});
                        updateClickBtn.popover('show');
                        setTimeout(function() {
                          updateClickBtn.popover("hide")
                          updateClickBtn.attr({"data-content": "Sản phẩm đã được cập nhật", "title": "Thành công"});}, 2200
                          ); 
                        console.log('error...ajax');
                        }
                  });
                  })
                });
                $('#products_table').DataTable( {
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
                });
          });

          $(".all-products-item").addClass("active");
        });


      </script>
    </body>
</html>